<!doctype html>

<html lang="ru">

<head>
	<meta charset = "utf-8">
	<title>Компьютерная алгебра</title>
	<link rel = "stylesheet" type = "text/css" href = "stylesheets/parser_style.css" media = "screen" />
</head>

<body>
	<header>
		<h1 id="logo">Парсим с Владимиром К.</h1><!--		
	 --><menu id="control"><!--
		 --><div id="expression" contenteditable="true">sin(3 / 2 * pi) + tan 3.1 - -var</div><!--
		 --><button id="go">Go</button><!--
	 --></menu>
	</header>
	
	<figure id="AST_area"></figure>
	
	<script src="libs/d3.min.js"></script>
	<script src="src/parser.js"></script>
	<script src="src/gui.js"></script>
	<script>
		var expr = document.getElementById('expression'),
			update = function() {
				var range = window.getSelection().getRangeAt(0),
					offset = range.startOffset,
					needsPreserve = range.startContainer.parentNode === expr;
				unmarkError();
				
				try {
					var astroot = parser.parse(expr.innerHTML);
					astroot.value();
					d3renderer.draw(astroot);
				} catch (err) {
					markError(err.position);
					console.log(err.message);
				}
				
				if (needsPreserve)
					range.setStart(expr.childNodes[0], offset);
			},
			markError = function(pos) {
				var current = expr.innerHTML;
				expr.innerHTML = current.substr(0, pos) + '<span id="error">' + current.substr(pos) + '</span>';
			},
			unmarkError = function() {
				expr.innerHTML = expr.innerHTML.replace(/<(.*?)>/g, '');
			},
			fitSVG = function(output) {
				d3renderer.resizeToFit();
				update();
			};
			
		
		document.getElementById('go').addEventListener('click', update);
		expr.addEventListener('keypress', function(e) {
			if (e.keyCode === 13) {
				e.preventDefault();
				update();
			}
		});
		window.addEventListener('resize', fitSVG);
		
		d3renderer.bind('AST_area');
		fitSVG();
	</script>
</body>

</html>